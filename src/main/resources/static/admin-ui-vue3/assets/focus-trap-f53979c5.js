import{x as e,H as t,r as n,d as o,p as s,m as r,f as a,D as u,b8 as c,j as d}from"./runtime-core.esm-bundler-ccc21fcd.js";import{l as i,_ as l}from"./base-085523fd.js";import{E as f}from"./aria-8fadfbe9.js";function p(e){return null==e}let v=[];const m=e=>{const t=e;t.key===f.esc&&v.forEach((e=>e(t)))},E="focus-trap.focus-after-trapped",y="focus-trap.focus-after-released",w={cancelable:!0,bubbles:!1},L={cancelable:!0,bubbles:!1},b="focusAfterTrapped",h="focusAfterReleased",T=Symbol("elFocusTrap"),k=n(),g=n(0),F=n(0);let R=0;const K=e=>{const t=[],n=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,{acceptNode:e=>{const t="INPUT"===e.tagName&&"hidden"===e.type;return e.disabled||e.hidden||t?NodeFilter.FILTER_SKIP:e.tabIndex>=0||e===document.activeElement?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}});for(;n.nextNode();)t.push(n.currentNode);return t},N=(e,t)=>{for(const n of e)if(!P(n,t))return n},P=(e,t)=>{if("hidden"===getComputedStyle(e).visibility)return!0;for(;e;){if(t&&e===t)return!1;if("none"===getComputedStyle(e).display)return!0;e=e.parentElement}return!1},S=(e,t)=>{if(e&&e.focus){const n=document.activeElement;e.focus({preventScroll:!0}),F.value=window.performance.now(),e!==n&&(e=>e instanceof HTMLInputElement&&"select"in e)(e)&&t&&e.select()}};function I(e,t){const n=[...e],o=e.indexOf(t);return-1!==o&&n.splice(o,1),n}const _=(e,t=!1)=>{const n=document.activeElement;for(const o of e)if(S(o,t),document.activeElement!==n)return},j=(()=>{let e=[];return{push:t=>{const n=e[0];n&&t!==n&&n.pause(),e=I(e,t),e.unshift(t)},remove:t=>{var n,o;e=I(e,t),null==(o=null==(n=e[0])?void 0:n.resume)||o.call(n)}}})(),C=()=>g.value>F.value,x=()=>{k.value="pointer",g.value=window.performance.now()},A=()=>{k.value="keyboard",g.value=window.performance.now()},D=e=>new CustomEvent("focus-trap.focusout-prevented",{...L,detail:e});var O=l(o({name:"ElFocusTrap",inheritAttrs:!1,props:{loop:Boolean,trapped:Boolean,focusTrapEl:Object,focusStartEl:{type:[Object,String],default:"first"}},emits:[b,h,"focusin","focusout","focusout-prevented","release-requested"],setup(o,{emit:d}){const l=n();let L,P;const{focusReason:I}=(e((()=>{0===R&&(document.addEventListener("mousedown",x),document.addEventListener("touchstart",x),document.addEventListener("keydown",A)),R++})),t((()=>{R--,R<=0&&(document.removeEventListener("mousedown",x),document.removeEventListener("touchstart",x),document.removeEventListener("keydown",A))})),{focusReason:k,lastUserFocusTimestamp:g,lastAutomatedFocusTimestamp:F});var O;O=e=>{o.trapped&&!H.paused&&d("release-requested",e)},e((()=>{0===v.length&&document.addEventListener("keydown",m),i&&v.push(O)})),t((()=>{v=v.filter((e=>e!==O)),0===v.length&&i&&document.removeEventListener("keydown",m)}));const H={paused:!1,pause(){this.paused=!0},resume(){this.paused=!1}},q=e=>{if(!o.loop&&!o.trapped)return;if(H.paused)return;const{key:t,altKey:n,ctrlKey:s,metaKey:r,currentTarget:a,shiftKey:u}=e,{loop:c}=o,i=t===f.tab&&!n&&!s&&!r,l=document.activeElement;if(i&&l){const t=a,[n,o]=(e=>{const t=K(e);return[N(t,e),N(t.reverse(),e)]})(t);if(n&&o)if(u||l!==o){if(u&&[n,t].includes(l)){const t=D({focusReason:I.value});d("focusout-prevented",t),t.defaultPrevented||(e.preventDefault(),c&&S(o,!0))}}else{const t=D({focusReason:I.value});d("focusout-prevented",t),t.defaultPrevented||(e.preventDefault(),c&&S(n,!0))}else if(l===t){const t=D({focusReason:I.value});d("focusout-prevented",t),t.defaultPrevented||e.preventDefault()}}};s(T,{focusTrapRef:l,onKeydown:q}),r((()=>o.focusTrapEl),(e=>{e&&(l.value=e)}),{immediate:!0}),r([l],(([e],[t])=>{e&&(e.addEventListener("keydown",q),e.addEventListener("focusin",U),e.addEventListener("focusout",W)),t&&(t.removeEventListener("keydown",q),t.removeEventListener("focusin",U),t.removeEventListener("focusout",W))}));const B=e=>{d(b,e)},M=e=>d(h,e),U=e=>{const t=a(l);if(!t)return;const n=e.target,s=e.relatedTarget,r=n&&t.contains(n);if(!o.trapped){s&&t.contains(s)||(L=s)}r&&d("focusin",e),H.paused||o.trapped&&(r?P=n:S(P,!0))},W=e=>{const t=a(l);if(!H.paused&&t)if(o.trapped){const n=e.relatedTarget;p(n)||t.contains(n)||setTimeout((()=>{if(!H.paused&&o.trapped){const e=D({focusReason:I.value});d("focusout-prevented",e),e.defaultPrevented||S(P,!0)}}),0)}else{const n=e.target;n&&t.contains(n)||d("focusout",e)}};async function $(){await u();const e=a(l);if(e){j.push(H);const t=e.contains(document.activeElement)?L:document.activeElement;L=t;if(!e.contains(t)){const n=new Event(E,w);e.addEventListener(E,B),e.dispatchEvent(n),n.defaultPrevented||u((()=>{let n=o.focusStartEl;c(n)||(S(n),document.activeElement!==n&&(n="first")),"first"===n&&_(K(e),!0),document.activeElement!==t&&"container"!==n||S(e)}))}}}function z(){const e=a(l);if(e){e.removeEventListener(E,B);const t=new CustomEvent(y,{...w,detail:{focusReason:I.value}});e.addEventListener(y,M),e.dispatchEvent(t),t.defaultPrevented||"keyboard"!=I.value&&C()||S(null!=L?L:document.body),e.removeEventListener(y,B),j.remove(H)}}return e((()=>{o.trapped&&$(),r((()=>o.trapped),(e=>{e?$():z()}))})),t((()=>{o.trapped&&z()})),{onKeydown:q}}}),[["render",function(e,t,n,o,s,r){return d(e.$slots,"default",{handleKeydown:e.onKeydown})}],["__file","/home/runner/work/element-plus/element-plus/packages/components/focus-trap/src/focus-trap.vue"]]);export{O as E,T as F,p as i};
