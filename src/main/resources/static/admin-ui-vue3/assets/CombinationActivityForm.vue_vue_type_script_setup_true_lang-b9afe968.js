import{ab as y,f as E,d as $,l as K,r as c,o as M,c as Q,i as n,w as m,a as l,j as P,B as W,q as X,x as Y,F as Z,ac as aa,a9 as ea,ae as ta,H as ra,bE as sa,J as ia,L as la,__tla as oa}from"./index-0f589822.js";import{_ as ca,__tla as ua}from"./Dialog.vue_vue_type_style_index_0_lang-2d188c85.js";import{_ as na,__tla as ma}from"./Form-89fb98fc.js";import{d as pa,g as x,__tla as da}from"./formatTime-58783104.js";import{r as i,__tla as _a}from"./formRules-04f2a102.js";import{D as fa,__tla as va}from"./dict-f9a1a53b.js";import{u as ya,__tla as ha}from"./useCrudSchemas-9a73989a.js";import{_ as ba,__tla as ga}from"./SpuSelect.vue_vue_type_script_setup_true_lang-c17b8a9f.js";import{_ as Sa,__tla as Ca}from"./SpuAndSkuList.vue_vue_type_script_setup_true_lang-e469030d.js";import{g as wa,__tla as Pa}from"./index-c338d539.js";import{h as ka,__tla as Fa}from"./spu-3234a0da.js";import{u as Ia,__tla as Ta}from"./useMessage-45ab706e.js";let R,k,A,O,Na=Promise.all([(()=>{try{return oa}catch{}})(),(()=>{try{return ua}catch{}})(),(()=>{try{return ma}catch{}})(),(()=>{try{return da}catch{}})(),(()=>{try{return _a}catch{}})(),(()=>{try{return va}catch{}})(),(()=>{try{return ha}catch{}})(),(()=>{try{return ga}catch{}})(),(()=>{try{return Ca}catch{}})(),(()=>{try{return Pa}catch{}})(),(()=>{try{return Fa}catch{}})(),(()=>{try{return Ta}catch{}})()]).then(async()=>{let F,I;O=async h=>await y.get({url:"/promotion/combination-activity/page",params:h}),A=async h=>await y.delete({url:"/promotion/combination-activity/delete?id="+h}),F=E({name:[i],totalLimitCount:[i],singleLimitCount:[i],startTime:[i],endTime:[i],userSize:[i],totalNum:[i],successNum:[i],orderUserCount:[i],virtualGroup:[i],status:[i],limitDuration:[i]}),I=E([{label:"\u62FC\u56E2\u540D\u79F0",field:"name",isSearch:!0,isTable:!1,form:{colProps:{span:24}}},{label:"\u6D3B\u52A8\u65F6\u95F4",field:"activityTime",formatter:pa,search:{show:!0,component:"DatePicker",componentProps:{valueFormat:"x",type:"datetimerange",rangeSeparator:"\u81F3"}},form:{component:"DatePicker",componentProps:{valueFormat:"x",type:"datetimerange",rangeSeparator:"\u81F3"},value:[x().valueOf(),x().valueOf()],colProps:{span:24}}},{label:"\u53C2\u4E0E\u4EBA\u6570",field:"orderUserCount",isSearch:!1,form:{component:"InputNumber",labelMessage:"\u53C2\u4E0E\u4EBA\u6570\u4E0D\u80FD\u5C11\u4E8E\u4E24\u4EBA",value:2}},{label:"\u9650\u5236\u65F6\u957F",field:"limitDuration",isSearch:!1,isTable:!1,form:{component:"InputNumber",labelMessage:"\u9650\u5236\u65F6\u957F(\u5C0F\u65F6)",componentProps:{placeholder:"\u8BF7\u8F93\u5165\u9650\u5236\u65F6\u957F(\u5C0F\u65F6)"}}},{label:"\u603B\u9650\u8D2D\u6570\u91CF",field:"totalLimitCount",isSearch:!1,isTable:!1,form:{component:"InputNumber",value:0}},{label:"\u5355\u6B21\u9650\u8D2D\u6570\u91CF",field:"singleLimitCount",isSearch:!1,isTable:!1,form:{component:"InputNumber",value:0}},{label:"\u8D2D\u4E70\u4EBA\u6570",field:"userSize",isSearch:!1,isForm:!1},{label:"\u5F00\u56E2\u7EC4\u6570",field:"totalNum",isSearch:!1,isForm:!1},{label:"\u6210\u56E2\u7EC4\u6570",field:"successNum",isSearch:!1,isForm:!1},{label:"\u865A\u62DF\u6210\u56E2",field:"virtualGroup",isSearch:!1,isTable:!1,isForm:!1},{label:"\u6D3B\u52A8\u72B6\u6001",field:"status",dictType:fa.COMMON_STATUS,dictClass:"number",isSearch:!0,isForm:!1},{label:"\u62FC\u56E2\u5546\u54C1",field:"spuId",isSearch:!1,form:{colProps:{span:24}}},{label:"\u64CD\u4F5C",field:"action",isForm:!1}]),{allSchemas:k}=ya(I),R=$({name:"PromotionCombinationActivityForm",__name:"CombinationActivityForm",emits:["success"],setup(h,{expose:j,emit:z}){const{t:C}=K(),T=Ia(),d=c(!1),N=c(""),_=c(!1),V=c(""),p=c(),L=c(),U=c(),b=c([]),w=c([]),G=[{name:"productConfig.activePrice",rule:t=>t>.01,message:"\u5546\u54C1\u62FC\u56E2\u4EF7\u683C\u4E0D\u80FD\u5C0F\u4E8E0.01 \uFF01\uFF01\uFF01"}],q=(t,a)=>{p.value.setValues({spuId:t}),D(t,a)},D=async(t,a,e)=>{var g;const o=[],u=await ka([t]);if(u.length==0)return;b.value=[];const r=u[0],f=a===void 0?r==null?void 0:r.skus:(g=r==null?void 0:r.skus)==null?void 0:g.filter(s=>a.includes(s.id));f==null||f.forEach(s=>{let v={spuId:r.id,skuId:s.id,activePrice:0};if(e!==void 0){const S=e.find(J=>J.skuId===s.id);S&&(S.activePrice=aa(S.activePrice)),v=S||v}s.productConfig=v}),r.skus=f,o.push({spuId:r.id,spuDetail:r,propertyList:wa(r)}),b.value.push(r),w.value=o};j({open:async(t,a)=>{var e;if(d.value=!0,N.value=C("action."+t),V.value=t,await B(),a){_.value=!0;try{const o=await(async u=>await y.get({url:"/promotion/combination-activity/get?id="+u}))(a);await D(o.spuId,(e=o.products)==null?void 0:e.map(u=>u.skuId),o.products),p.value.setValues(o)}finally{_.value=!1}}}});const B=async()=>{b.value=[],w.value=[],await ea(),p.value.getElFormRef().resetFields()},H=async()=>{if(p&&await p.value.getElFormRef().validate()){_.value=!0;try{const t=p.value.formModel,a=U.value.getSkuConfigs("productConfig");a.forEach(e=>{e.activePrice=ta(e.activePrice)}),t.products=a,V.value==="create"?(await(async e=>await y.post({url:"/promotion/combination-activity/create",data:e}))(t),T.success(C("common.createSuccess"))):(await(async e=>await y.put({url:"/promotion/combination-activity/update",data:e}))(t),T.success(C("common.updateSuccess"))),d.value=!1,z("success")}finally{_.value=!1}}};return(t,a)=>{const e=ra,o=sa,u=ia,r=na,f=ca,g=la;return M(),Q(Z,null,[n(f,{modelValue:l(d),"onUpdate:modelValue":a[2]||(a[2]=s=>Y(d)?d.value=s:null),title:l(N),width:"65%"},{footer:m(()=>[n(e,{disabled:l(_),type:"primary",onClick:H},{default:m(()=>[P("\u786E \u5B9A")]),_:1},8,["disabled"]),n(e,{onClick:a[1]||(a[1]=s=>d.value=!1)},{default:m(()=>[P("\u53D6 \u6D88")]),_:1})]),default:m(()=>[W((M(),X(r,{ref_key:"formRef",ref:p,"is-col":!0,rules:l(F),schema:l(k).formSchema},{spuId:m(()=>[n(e,{onClick:a[0]||(a[0]=s=>l(L).open())},{default:m(()=>[P("\u9009\u62E9\u5546\u54C1")]),_:1}),n(l(Sa),{ref_key:"spuAndSkuListRef",ref:U,"rule-config":G,"spu-list":l(b),"spu-property-list-p":l(w)},{default:m(()=>[n(u,{align:"center",label:"\u62FC\u56E2\u4EF7\u683C(\u5143)","min-width":"168"},{default:m(({row:s})=>[n(o,{modelValue:s.productConfig.activePrice,"onUpdate:modelValue":v=>s.productConfig.activePrice=v,min:0,precision:2,step:.1,class:"w-100%"},null,8,["modelValue","onUpdate:modelValue"])]),_:1})]),_:1},8,["spu-list","spu-property-list-p"])]),_:1},8,["rules","schema"])),[[g,l(_)]])]),_:1},8,["modelValue","title"]),n(l(ba),{ref_key:"spuSelectRef",ref:L,isSelectSku:!0,onConfirm:q},null,512)],64)}}})});export{R as _,Na as __tla,k as a,A as d,O as g};
